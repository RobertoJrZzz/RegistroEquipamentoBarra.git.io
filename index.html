<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Equipamentos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      transition: background 0.3s, color 0.3s;
    }

    h1 {
      text-align: center;
    }

    form,
    .acoes {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: background 0.3s, color 0.3s;
    }

    input,
    button,
    select {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      font-size: 16px;
      transition: background 0.3s, color 0.3s;
    }

    table {
      width: 100%;
      margin-top: 30px;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background: #007bff;
      color: white;
    }

    tr.nao-retornado {
      background-color: #fff3cd;
    }

    tr.retornado {
      background-color: #d4edda;
    }

    .botao-retorno,
    .botao-editar,
    .botao-salvar {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
      background: none;
      border: none;
      font-size: 14px;
      padding: 0;
      margin: 0 5px;
    }

    .acoes button {
      margin-bottom: 10px;
      width: auto;
      display: inline-block;
      margin-right: 10px;
    }

    /* Modo escuro */
    body.modo-escuro {
      background-color: #121212;
      color: #e0e0e0;
    }

    body.modo-escuro form,
    body.modo-escuro .acoes,
    body.modo-escuro table {
      background-color: #1e1e1e;
      color: #ffffff;
    }

    body.modo-escuro th {
      background-color: #333;
    }

    body.modo-escuro tr.nao-retornado {
      background-color: #4c4c1a;
    }

    body.modo-escuro tr.retornado {
      background-color: #1f5e3d;
    }

    body.modo-escuro input,
    body.modo-escuro button,
    body.modo-escuro select {
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
    }

    .switch-container {
      text-align: center;
      margin-bottom: 20px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      background-color: #ccc;
      border-radius: 34px;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      transition: background-color 0.3s;
    }

    .slider::before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    input:checked + .slider {
      background-color: #4caf50;
    }

    input:checked + .slider::before {
      transform: translateX(26px);
    }

    .icon {
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 20px;
      transition: opacity 0.3s;
    }

    /* Logo centralizada e tamanho reduzido */
    .logo {
      display: flex;
      justify-content: center;
      padding: 10px 0;
    }

    .logo img {
      max-height: 80px;
      width: auto;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="./img/barra dor.png" alt="Logo" />
  </div>

  <h1>Registro de Entrega de Equipamentos</h1>

  <div class="switch-container">
    <label class="switch">
      <input type="checkbox" id="modoToggle" onchange="alternarModo()" />
      <span class="slider">
        <span id="modoIcon" class="icon">üåû</span>
      </span>
    </label>
  </div>

  <form id="registroForm">
    <!-- Tipo de registro fixo para "Sa√≠da" -->
    <input type="hidden" id="tipo" value="Sa√≠da" />

    <label for="equipamento">Nome do Equipamento:</label>
    <input type="text" id="equipamento" required />

    <label for="quemPegou">Quem pegou:</label>
    <input type="text" id="quemPegou" required />

    <label for="setor">Setor:</label>
    <input type="text" id="setor" required />

    <label for="liberadoPor">Liberado por:</label>
    <input type="text" id="liberadoPor" required />

    <button type="submit">Registrar</button>
  </form>

  <div class="acoes">
    <button onclick="exportarExcel()">üìä Exportar para Excel</button>
    <button onclick="exportarPDF()">üìÑ Salvar em PDF</button>
    <button onclick="limparRegistros()">üóëÔ∏è Limpar Lista</button>
  </div>

  <table id="tabelaRegistros">
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Equipamento</th>
        <th>Quem Pegou</th>
        <th>Setor</th>
        <th>Data</th>
        <th>Hora</th>
        <th>Liberado por</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    function carregarModo() {
      const modo = localStorage.getItem("modo") || "modo-claro";
      document.body.className = modo;

      const toggle = document.getElementById("modoToggle");
      const icon = document.getElementById("modoIcon");

      toggle.checked = modo === "modo-escuro";
      icon.textContent = toggle.checked ? "üåô" : "üåû";
    }

    function alternarModo() {
      const toggle = document.getElementById("modoToggle");
      const icon = document.getElementById("modoIcon");
      const modo = toggle.checked ? "modo-escuro" : "modo-claro";
      document.body.className = modo;
      localStorage.setItem("modo", modo);
      icon.textContent = toggle.checked ? "üåô" : "üåû";
    }

    const form = document.getElementById("registroForm");
    const tabela = document.querySelector("#tabelaRegistros tbody");

    window.onload = function () {
      carregarModo();
      const registrosSalvos = JSON.parse(localStorage.getItem("registros")) || [];
      registrosSalvos.forEach((registro, index) =>
        adicionarLinhaNaTabela(registro, index)
      );
    };

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const tipo = "Sa√≠da";
      const equipamento = document.getElementById("equipamento").value;
      const quemPegou = document.getElementById("quemPegou").value;
      const setor = document.getElementById("setor").value;
      const liberadoPor = document.getElementById("liberadoPor").value;

      const agora = new Date();
      const data = agora.toLocaleDateString();
      const hora = agora.toLocaleTimeString();

      const registro = {
        tipo,
        equipamento,
        quemPegou,
        setor,
        data,
        hora,
        liberadoPor,
        retornado: false,
        dataRetorno: null,
      };

      const registros = JSON.parse(localStorage.getItem("registros")) || [];
      registros.push(registro);
      localStorage.setItem("registros", JSON.stringify(registros));

      adicionarLinhaNaTabela(registro, registros.length - 1);
      form.reset();
    });

    function adicionarLinhaNaTabela(registro, index) {
      const novaLinha = tabela.insertRow();
      novaLinha.className = registro.retornado ? "retornado" : "nao-retornado";

      novaLinha.innerHTML = `
        <td>${registro.tipo}</td>
        <td>${registro.equipamento}</td>
        <td>${registro.quemPegou}</td>
        <td>${registro.setor}</td>
        <td>${registro.data}</td>
        <td>${registro.hora}</td>
        <td>${registro.liberadoPor}</td>
        <td class="status-cell">
          ${
            registro.retornado
              ? `Retornado em ${registro.dataRetorno}`
              : `<button class="botao-retorno" onclick="registrarRetorno(${index}, this)">Marcar Retorno</button>`
          }
        </td>
        <td>
          <button class="botao-editar" onclick="editarRegistro(this, ${index})">Editar</button>
        </td>
      `;
    }

    function registrarRetorno(index, elemento) {
      const registros = JSON.parse(localStorage.getItem("registros")) || [];
      const registro = registros[index];

      if (!registro.retornado) {
        const agora = new Date();
        const dataRetorno =
          agora.toLocaleDateString() + " " + agora.toLocaleTimeString();
        registro.retornado = true;
        registro.dataRetorno = dataRetorno;

        registros[index] = registro;
        localStorage.setItem("registros", JSON.stringify(registros));

        const linha = elemento.closest("tr");
        linha.classList.remove("nao-retornado");
        linha.classList.add("retornado");
        elemento.outerHTML = `Retornado em ${dataRetorno}`;
      }
    }

    function limparRegistros() {
      if (confirm("Tem certeza que deseja limpar todos os registros?")) {
        localStorage.removeItem("registros");
        tabela.innerHTML = "";
      }
    }

    function exportarExcel() {
      const registros = JSON.parse(localStorage.getItem("registros")) || [];
      const dados = registros.map((r) => ({
        Tipo: r.tipo,
        Equipamento: r.equipamento,
        "Quem Pegou": r.quemPegou,
        Setor: r.setor,
        Data: r.data,
        Hora: r.hora,
        "Liberado por": r.liberadoPor,
        Status: r.retornado
          ? `Retornado em ${r.dataRetorno}`
          : "N√£o retornado",
      }));

      const ws = XLSX.utils.json_to_sheet(dados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Registros");
      XLSX.writeFile(wb, "registro_equipamentos.xlsx");
    }

    function exportarPDF() {
      const registros = JSON.parse(localStorage.getItem("registros")) || [];
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Registro de Equipamentos", 14, 20);

      const colunas = [
        "Tipo",
        "Equipamento",
        "Quem Pegou",
        "Setor",
        "Data",
        "Hora",
        "Liberado por",
        "Status",
      ];
      const linhas = registros.map((r) => [
        r.tipo,
        r.equipamento,
        r.quemPegou,
        r.setor,
        r.data,
        r.hora,
        r.liberadoPor,
        r.retornado ? `Retornado em ${r.dataRetorno}` : "N√£o retornado",
      ]);

      doc.autoTable({
        startY: 30,
        head: [colunas],
        body: linhas,
        styles: { fontSize: 10 },
      });

      doc.save("registro_equipamentos.pdf");
    }

    function editarRegistro(botao, index) {
      const registros = JSON.parse(localStorage.getItem("registros")) || [];
      const registro = registros[index];
      const linha = botao.closest("tr");

      // Se o bot√£o for "Editar", transforma a linha em inputs
      if (botao.textContent === "Editar") {
        // S√≥ permite editar se n√£o for retornado (porque data/hora etc √© fixo e n√£o faz sentido alterar status por aqui)
        if (registro.retornado) {
          alert(
            "Registros retornados n√£o podem ser editados para evitar inconsist√™ncias."
          );
          return;
        }

        linha.innerHTML = `
          <td>${registro.tipo}</td>
          <td><input type="text" value="${registro.equipamento}" /></td>
          <td><input type="text" value="${registro.quemPegou}" /></td>
          <td><input type="text" value="${registro.setor}" /></td>
          <td>${registro.data}</td>
          <td>${registro.hora}</td>
          <td><input type="text" value="${registro.liberadoPor}" /></td>
          <td>
            <button class="botao-retorno" onclick="registrarRetorno(${index}, this)">Marcar Retorno</button>
          </td>
          <td>
            <button class="botao-salvar" onclick="salvarEdicao(this, ${index})">Salvar</button>
            <button class="botao-cancelar" onclick="cancelarEdicao(${index})">Cancelar</button>
          </td>
        `;
      }
    }

    function salvarEdicao(botao, index) {
      const linha = botao.closest("tr");
      const inputs = linha.querySelectorAll("input");
      const equipamento = inputs[0].value.trim();
      const quemPegou = inputs[1].value.trim();
      const setor = inputs[2].value.trim();
      const liberadoPor = inputs[3].value.trim();

      if (!equipamento || !quemPegou || !setor || !liberadoPor) {
        alert("Por favor, preencha todos os campos.");
        return;
      }

      const registros = JSON.parse(localStorage.getItem("registros")) || [];
      const registro = registros[index];

      registro.equipamento = equipamento;
      registro.quemPegou = quemPegou;
      registro.setor = setor;
      registro.liberadoPor = liberadoPor;

      registros[index] = registro;
      localStorage.setItem("registros", JSON.stringify(registros));

      // Atualiza a linha na tabela
      linha.className = registro.retornado ? "retornado" : "nao-retornado";
      linha.innerHTML = `
        <td>${registro.tipo}</td>
        <td>${registro.equipamento}</td>
        <td>${registro.quemPegou}</td>
        <td>${registro.setor}</td>
        <td>${registro.data}</td>
        <td>${registro.hora}</td>
        <td>${registro.liberadoPor}</td>
        <td class="status-cell">
          ${
            registro.retornado
              ? `Retornado em ${registro.dataRetorno}`
              : `<button class="botao-retorno" onclick="registrarRetorno(${index}, this)">Marcar Retorno</button>`
          }
        </td>
        <td>
          <button class="botao-editar" onclick="editarRegistro(this, ${index})">Editar</button>
        </td>
      `;
    }

    function cancelarEdicao(index) {
      const registros = JSON.parse(localStorage.getItem("registros")) || [];
      const registro = registros[index];
      const linhas = tabela.querySelectorAll("tr");
      const linha = linhas[index];

      linha.className = registro.retornado ? "retornado" : "nao-retornado";
      linha.innerHTML = `
        <td>${registro.tipo}</td>
        <td>${registro.equipamento}</td>
        <td>${registro.quemPegou}</td>
        <td>${registro.setor}</td>
        <td>${registro.data}</td>
        <td>${registro.hora}</td>
        <td>${registro.liberadoPor}</td>
        <td class="status-cell">
          ${
            registro.retornado
              ? `Retornado em ${registro.dataRetorno}`
              : `<button class="botao-retorno" onclick="registrarRetorno(${index}, this)">Marcar Retorno</button>`
          }
        </td>
        <td>
          <button class="botao-editar" onclick="editarRegistro(this, ${index})">Editar</button>
        </td>
      `;
    }
  </script>
</body>
</html>
